<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sleep Efficiency Overview</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
  <h2>Sleep Efficiency for Userid 1</h2>
  <div id="efficiencyChart" style="width: 100%; height: 80vh;"></div>

  <script>
    async function drawChart() {
      try {
        const response = await fetch("http://127.0.0.1:8080/sleep-api/efficiency/1");
        if (!response.ok) throw new Error("API fetch failed");
        
        const result = await response.json();
        console.log(result); // Debug output
        
        // Handle array or single object response
        const efficiencyData = Array.isArray(result) ? result[0] : result;

        if (!efficiencyData) {
          document.getElementById("efficiencyChart").innerText = "Failed to fetch data.";
          return;
        }

        const labels = ["Light Sleep", "REM Sleep", "Deep Sleep"];
        const values = [efficiencyData.light, efficiencyData.rem, efficiencyData.deep];

        const data = [{
          values: values,
          labels: labels,
          type: "pie",
          textinfo: "label+percent",
          hole: 0.4
        }];

        const layout = {
          title: `Sleep Stage Breakdown - Efficiency Score: ${(efficiencyData.efficiency * 100).toFixed(2)}%`
        };

        Plotly.newPlot("efficiencyChart", data, layout);
      } catch (error) {
        console.error("Chart error:", error);
        document.getElementById("efficiencyChart").innerText = "Failed to fetch data: " + error.message;
      }
    }

    drawChart();
  </script>
</body>
</html>